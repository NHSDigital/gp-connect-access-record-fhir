steps:
  - template: "azure/components/aws-assume-role.yml@common"
    parameters:
      role: "auto-ops"
      profile: "apm_ptl"

  - template: "azure/components/get-aws-secrets-and-ssm-params.yml@common"
    parameters:
      secret_ids:
        - ptl/azure-devops/apigee-nonprod/APIGEE_OTP_KEY
        - ptl/azure-devops/apigee-nonprod/APIGEE_PASSWORD
      config_ids:
        - /ptl/azure-devops/apigee-nonprod/APIGEE_USERNAME

  - template: "azure/components/get-mfa-code.yml@common"
    parameters:
      apigee_otp_key: $(APIGEE_OTP_KEY)

  - template: "azure/components/get-access-token.yml@common"
    parameters:
      apigee_username: $(APIGEE_USERNAME)
      apigee_password: $(APIGEE_PASSWORD)

  - bash: |
      echo $(curl -X GET -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $(secret.AccessToken)" "https://api.enterprise.apigee.com/v1/organizations/nhsd-nonprod/environments/internal-dev/keyvaluemaps/gp-connect-access-record-endpoints-PR")
    displayName: Test Access Token with GET request

  - bash: |
      export APIGEE_ENVIRONMENT="internal-dev"
      export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"

      make remove-kvm-entry
    displayName: Update endpoints KVM
